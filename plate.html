<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />
<meta name="generator" content="pdoc 0.9.2" />
<title>plaque_assay.plate API documentation</title>
<meta name="description" content="Mock 96-well plates of a single dilution, taken from the physical
384 well plates …" />
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/sanitize.min.css" integrity="sha256-PK9q560IAAa6WVRRh76LtCaI8pjTJ2z11v0miyNNjrs=" crossorigin>
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/typography.min.css" integrity="sha256-7l/o7C8jubJiy74VsKTidCy1yBkRtiUGbVkYBylBqUg=" crossorigin>
<link rel="stylesheet preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/styles/github.min.css" crossorigin>
<style>:root{--highlight-color:#fe9}.flex{display:flex !important}body{line-height:1.5em}#content{padding:20px}#sidebar{padding:30px;overflow:hidden}#sidebar > *:last-child{margin-bottom:2cm}.http-server-breadcrumbs{font-size:130%;margin:0 0 15px 0}#footer{font-size:.75em;padding:5px 30px;border-top:1px solid #ddd;text-align:right}#footer p{margin:0 0 0 1em;display:inline-block}#footer p:last-child{margin-right:30px}h1,h2,h3,h4,h5{font-weight:300}h1{font-size:2.5em;line-height:1.1em}h2{font-size:1.75em;margin:1em 0 .50em 0}h3{font-size:1.4em;margin:25px 0 10px 0}h4{margin:0;font-size:105%}h1:target,h2:target,h3:target,h4:target,h5:target,h6:target{background:var(--highlight-color);padding:.2em 0}a{color:#058;text-decoration:none;transition:color .3s ease-in-out}a:hover{color:#e82}.title code{font-weight:bold}h2[id^="header-"]{margin-top:2em}.ident{color:#900}pre code{background:#f8f8f8;font-size:.8em;line-height:1.4em}code{background:#f2f2f1;padding:1px 4px;overflow-wrap:break-word}h1 code{background:transparent}pre{background:#f8f8f8;border:0;border-top:1px solid #ccc;border-bottom:1px solid #ccc;margin:1em 0;padding:1ex}#http-server-module-list{display:flex;flex-flow:column}#http-server-module-list div{display:flex}#http-server-module-list dt{min-width:10%}#http-server-module-list p{margin-top:0}.toc ul,#index{list-style-type:none;margin:0;padding:0}#index code{background:transparent}#index h3{border-bottom:1px solid #ddd}#index ul{padding:0}#index h4{margin-top:.6em;font-weight:bold}@media (min-width:200ex){#index .two-column{column-count:2}}@media (min-width:300ex){#index .two-column{column-count:3}}dl{margin-bottom:2em}dl dl:last-child{margin-bottom:4em}dd{margin:0 0 1em 3em}#header-classes + dl > dd{margin-bottom:3em}dd dd{margin-left:2em}dd p{margin:10px 0}.name{background:#eee;font-weight:bold;font-size:.85em;padding:5px 10px;display:inline-block;min-width:40%}.name:hover{background:#e0e0e0}dt:target .name{background:var(--highlight-color)}.name > span:first-child{white-space:nowrap}.name.class > span:nth-child(2){margin-left:.4em}.inherited{color:#999;border-left:5px solid #eee;padding-left:1em}.inheritance em{font-style:normal;font-weight:bold}.desc h2{font-weight:400;font-size:1.25em}.desc h3{font-size:1em}.desc dt code{background:inherit}.source summary,.git-link-div{color:#666;text-align:right;font-weight:400;font-size:.8em;text-transform:uppercase}.source summary > *{white-space:nowrap;cursor:pointer}.git-link{color:inherit;margin-left:1em}.source pre{max-height:500px;overflow:auto;margin:0}.source pre code{font-size:12px;overflow:visible}.hlist{list-style:none}.hlist li{display:inline}.hlist li:after{content:',\2002'}.hlist li:last-child:after{content:none}.hlist .hlist{display:inline;padding-left:1em}img{max-width:100%}td{padding:0 .5em}.admonition{padding:.1em .5em;margin-bottom:1em}.admonition-title{font-weight:bold}.admonition.note,.admonition.info,.admonition.important{background:#aef}.admonition.todo,.admonition.versionadded,.admonition.tip,.admonition.hint{background:#dfd}.admonition.warning,.admonition.versionchanged,.admonition.deprecated{background:#fd4}.admonition.error,.admonition.danger,.admonition.caution{background:lightpink}</style>
<style media="screen and (min-width: 700px)">@media screen and (min-width:700px){#sidebar{width:30%;height:100vh;overflow:auto;position:sticky;top:0}#content{width:70%;max-width:100ch;padding:3em 4em;border-left:1px solid #ddd}pre code{font-size:1em}.item .name{font-size:1em}main{display:flex;flex-direction:row-reverse;justify-content:flex-end}.toc ul ul,#index ul{padding-left:1.5em}.toc > ul > li{margin-top:.5em}}</style>
<style media="print">@media print{#sidebar h1{page-break-before:always}.source{display:none}}@media print{*{background:transparent !important;color:#000 !important;box-shadow:none !important;text-shadow:none !important}a[href]:after{content:" (" attr(href) ")";font-size:90%}a[href][title]:after{content:none}abbr[title]:after{content:" (" attr(title) ")"}.ir a:after,a[href^="javascript:"]:after,a[href^="#"]:after{content:""}pre,blockquote{border:1px solid #999;page-break-inside:avoid}thead{display:table-header-group}tr,img{page-break-inside:avoid}img{max-width:100% !important}@page{margin:0.5cm}p,h2,h3{orphans:3;widows:3}h1,h2,h3,h4,h5,h6{page-break-after:avoid}}</style>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/highlight.min.js" integrity="sha256-Uv3H6lx7dJmRfRvH8TH6kJD1TSK1aFcwgx+mdg3epi8=" crossorigin></script>
<script>window.addEventListener('DOMContentLoaded', () => hljs.initHighlighting())</script>
</head>
<body>
<main>
<article id="content">
<header>
<h1 class="title">Module <code>plaque_assay.plate</code></h1>
</header>
<section id="section-intro">
<p>Mock 96-well plates of a single dilution, taken from the physical
384 well plates.</p>
<p>The assay originated in 96-well plates, with a dilution per plate
totalling 4 plates.
This was then taken forward when the assay moved
to 384-well plates, where all 4 dilutions were present on a single
384-well plate, with samples dilution in quadrants, so a sample was
deposited in 4 adjacent wells, each well a different dilution.</p>
<p>e.g in the physical 384-well plate where <code>A</code> and <code>B</code> are the samples,
and <code>1</code>, <code>2</code>, <code>3</code>, <code>4</code> are the dilution integers.</p>
<pre><code class="language-txt">    01   02
  +----+----+
A | A4 | A3 |
  +----+----+
B | A2 | A1 |
  +----+----+
C | B4 | B3 |
  +----+----+
D | B2 | B1 |
  +----+----+
</code></pre>
<p>This also means that the well labels in this class have been converted from their
384-well plate quadrant to the 96 well equivalent. This is carried out in
<code><a title="plaque_assay.utils.well_384_to_96" href="utils.html#plaque_assay.utils.well_384_to_96">well_384_to_96()</a></code>.</p>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">&#34;&#34;&#34;
Mock 96-well plates of a single dilution, taken from the physical
384 well plates.

The assay originated in 96-well plates, with a dilution per plate
totalling 4 plates.  This was then taken forward when the assay moved
to 384-well plates, where all 4 dilutions were present on a single
384-well plate, with samples dilution in quadrants, so a sample was
deposited in 4 adjacent wells, each well a different dilution.

e.g in the physical 384-well plate where `A` and `B` are the samples,
and `1`, `2`, `3`, `4` are the dilution integers.

```txt
    01   02
  +----+----+
A | A4 | A3 |
  +----+----+
B | A2 | A1 |
  +----+----+
C | B4 | B3 |
  +----+----+
D | B2 | B1 |
  +----+----+
```

This also means that the well labels in this class have been converted from their
384-well plate quadrant to the 96 well equivalent. This is carried out in
`plaque_assay.utils.well_384_to_96()`.
&#34;&#34;&#34;

import os
from typing import Set

import pandas as pd

from . import failure
from . import qc_criteria
from .consts import VIRUS_ONLY_WELLS, NO_VIRUS_WELLS


class Plate:
    &#34;&#34;&#34;Plate class

    This is not the physical 384-well plate, but the mock 96-well
    plate of a single dilution.


    Parameters
    -----------
    df : pandas.DataFrame

    Attributes
    -----------
    df : pandas.DataFrame
        Dataframe, similar to input `df` but with additional columns from
        `Plate.subtract_plaque_area_background()` and
        `Plate.calc_percentage_infected()`.
    barcode : string
        Mock plate barcode. This is not the scanned barcode,
        but the mock 96-well plate barcode determined from the
        actual 384-well barcode.
    dilution : int
        Dilution integer of the plate, (1, 2, 3, 4).
    plate_failed : bool
        `True` if the entire plate is a QC failure, otherwise `False`.
    well_failures : list
        List containing WellFailure classes if any wells have failed.
    plate_failures : list
        List containing PlateFailure classes if the plate has failed
        for one of more QC reasons.
    &#34;&#34;&#34;

    def __init__(self, df: pd.DataFrame):
        self.df = self.subtract_plaque_area_background(df)
        assert df[&#34;PlateNum&#34;].nunique() == 1
        self.barcode = df[&#34;Plate_barcode&#34;].values[0]
        assert df[&#34;Dilution&#34;].nunique() == 1
        self.dilution = df[&#34;Dilution&#34;].values[0]
        self.plate_failed = False
        self.well_failures: Set[failure.WellFailure] = set()
        self.plate_failures: Set[failure.PlateFailure] = set()
        self.calc_percentage_infected()
        self.outside_image_area()

    def __len__(self):
        return self.df.shape[0]

    def __str__(self):
        return f&#34;Plate {self.barcode}&#34;

    def outside_image_area(self) -&gt; None:
        &#34;&#34;&#34;QC check for `cell_region_area`

        Determines if `cell_region_area` is outside the expected range and
        adds any failures to `well_failures`.
        &#34;&#34;&#34;
        feature = &#34;Cells - Image Region Area [µm²] - Mean per Well&#34;
        experiment_median = self.df[feature].median()
        ratio = self.df[feature] / experiment_median
        self.df[&#34;ratio&#34;] = ratio
        lower_limit = qc_criteria.low_cells_image_region_area_low
        upper_limit = qc_criteria.low_cells_image_region_area_high
        low = self.df[self.df[&#34;ratio&#34;] &lt; lower_limit]
        high = self.df[self.df[&#34;ratio&#34;] &gt; upper_limit]
        outliers = pd.concat([low, high])
        control_outliers = outliers[outliers[&#34;Well&#34;].str.endswith(&#34;12&#34;)]
        if control_outliers.shape[0] &gt; 0:
            # plate failure due to control well failure
            self.plate_failed = True
            failed_plate = failure.PlateFailure(
                plate=self.barcode,
                wells=&#34;;&#34;.join(control_outliers[&#34;Well&#34;].tolist()),
                failure_reason=failure.CELL_IMAGE_AREA_FAILURE_REASON,
            )
            self.plate_failures.add(failed_plate)
        if outliers.shape[0]:
            for _, row in outliers.iterrows():
                well_failure = failure.WellFailure(
                    well=row[&#34;Well&#34;],
                    plate=self.barcode,
                    failure_reason=failure.CELL_REGION_FAILURE_REASON,
                )
                self.well_failures.add(well_failure)
            # if there&#39;s more than 8 failures for DAPI wells, then flag
            # as a possible plate failure
            if outliers.shape[0] &gt; 8:
                # flag possible plate fail
                failed_plate = failure.PlateFailure(
                    plate=self.barcode,
                    wells=&#34;;&#34;.join(outliers[&#34;Well&#34;].tolist()),
                    failure_reason=failure.DAPI_PLATE_FAILURE_REASON,
                )
                self.plate_failures.add(failed_plate)

    def subtract_plaque_area_background(self, df: pd.DataFrame) -&gt; pd.DataFrame:
        &#34;&#34;&#34;Remove background from `plaque_area`.

        1. Calculate the median of &#34;Normalised Plaque area&#34; fo no virus wells.

        2. Subtract median from &#34;Normalised Plaque area&#34; for each well and save
          as &#34;Background Subtracted Plaque Area&#34;

        This is now done on a plate-by-plate basis.

        Parameters
        -----------
        df : pandas.DataFrame

        Returns
        -------
        pandas.DataFrame
        &#34;&#34;&#34;
        feature = &#34;Normalised Plaque area&#34;
        new_colname = &#34;Background Subtracted Plaque Area&#34;
        no_virus_bool = df.Well.isin(NO_VIRUS_WELLS)
        background = df[no_virus_bool][feature].median()
        df[new_colname] = df[feature] - background
        return df

    def check_infection(self, infection: float) -&gt; None:
        &#34;&#34;&#34;
        Determines if infection rate of virus-only-wells is within
        acceptable limts, flag as a plate failure if this is false.

        Parameters
        -----------
        infection: float
            infection rate of virus-only wells

        Returns
        -------
        None
            Adds a `plaque_assay.failure.PlateFailure` to
            `self.plate_failures` if plate has failed.
        &#34;&#34;&#34;
        lower_limit = qc_criteria.infection_rate_low
        upper_limit = qc_criteria.infection_rate_high
        if infection &lt; lower_limit or infection &gt; upper_limit:
            reason = f&#34;virus-only infection median ({infection:3f}) outside range: ({lower_limit}, {upper_limit})&#34;
            self.plate_failed = True
            failed_plate = failure.PlateFailure(
                plate=self.barcode,
                wells=&#34;;&#34;.join(VIRUS_ONLY_WELLS),
                failure_reason=reason,
            )
            self.plate_failures.add(failed_plate)

    def calc_percentage_infected(self) -&gt; None:
        &#34;&#34;&#34;Calculate percentage infected.

        `Percentage Infected` is the `Background Subtracted Plaque Area`
        divided by the median of the virus only wells x 100.

        Notes
        ------
        Also carries out a QC check. Determines if infection rate of
        virus-only-wells is within acceptable limts, flag the plate if
        this is false.
        &#34;&#34;&#34;
        feature = &#34;Background Subtracted Plaque Area&#34;
        virus_only_bool = self.df.Well.isin(VIRUS_ONLY_WELLS)
        infection = self.df[virus_only_bool][feature].median()
        self.check_infection(infection)
        self.df[&#34;Percentage Infected&#34;] = self.df[feature] / infection * 100

    def get_normalised_data(self) -&gt; pd.DataFrame:
        &#34;&#34;&#34;Return a simplified dataframe of just the normalised data

        This subsets and renames some columns.

        Returns
        -------
        pandas.DataFrame
        &#34;&#34;&#34;
        wanted_cols = [
            &#34;Well&#34;,
            &#34;Row&#34;,
            &#34;Column&#34;,
            &#34;Dilution&#34;,
            &#34;Plate_barcode&#34;,
            &#34;Background Subtracted Plaque Area&#34;,
            &#34;Percentage Infected&#34;,
            &#34;variant&#34;,
        ]
        temp_df = self.df.copy()
        df_wanted = temp_df[wanted_cols]
        df_wanted = df_wanted.rename(
            columns={
                &#34;Background Subtracted Plaque Area&#34;: &#34;Background_subtracted_plaque_area&#34;,
                &#34;Percentage Infected&#34;: &#34;Percentage_infected&#34;,
            }
        )
        return df_wanted

    def save_normalised_data(self, output_dir: str) -&gt; None:
        &#34;&#34;&#34;Save csv of the normalised data

        Parameters
        -----------
        output_dir : str
            directory in which to save the csv file
        &#34;&#34;&#34;
        norm_data = self.get_normalised_data()
        save_path = os.path.join(output_dir, f&#34;{self.barcode}.csv&#34;)
        norm_data.to_csv(save_path, index=False)</code></pre>
</details>
</section>
<section>
</section>
<section>
</section>
<section>
</section>
<section>
<h2 class="section-title" id="header-classes">Classes</h2>
<dl>
<dt id="plaque_assay.plate.Plate"><code class="flex name class">
<span>class <span class="ident">Plate</span></span>
<span>(</span><span>df: pandas.core.frame.DataFrame)</span>
</code></dt>
<dd>
<div class="desc"><p>Plate class</p>
<p>This is not the physical 384-well plate, but the mock 96-well
plate of a single dilution.</p>
<h2 id="parameters">Parameters</h2>
<dl>
<dt><strong><code>df</code></strong> :&ensp;<code>pandas.DataFrame</code></dt>
<dd>&nbsp;</dd>
</dl>
<h2 id="attributes">Attributes</h2>
<dl>
<dt><strong><code>df</code></strong> :&ensp;<code>pandas.DataFrame</code></dt>
<dd>Dataframe, similar to input <code>df</code> but with additional columns from
<code><a title="plaque_assay.plate.Plate.subtract_plaque_area_background" href="#plaque_assay.plate.Plate.subtract_plaque_area_background">Plate.subtract_plaque_area_background()</a></code> and
<code><a title="plaque_assay.plate.Plate.calc_percentage_infected" href="#plaque_assay.plate.Plate.calc_percentage_infected">Plate.calc_percentage_infected()</a></code>.</dd>
<dt><strong><code>barcode</code></strong> :&ensp;<code>string</code></dt>
<dd>Mock plate barcode. This is not the scanned barcode,
but the mock 96-well plate barcode determined from the
actual 384-well barcode.</dd>
<dt><strong><code>dilution</code></strong> :&ensp;<code>int</code></dt>
<dd>Dilution integer of the plate, (1, 2, 3, 4).</dd>
<dt><strong><code>plate_failed</code></strong> :&ensp;<code>bool</code></dt>
<dd><code>True</code> if the entire plate is a QC failure, otherwise <code>False</code>.</dd>
<dt><strong><code>well_failures</code></strong> :&ensp;<code>list</code></dt>
<dd>List containing WellFailure classes if any wells have failed.</dd>
<dt><strong><code>plate_failures</code></strong> :&ensp;<code>list</code></dt>
<dd>List containing PlateFailure classes if the plate has failed
for one of more QC reasons.</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">class Plate:
    &#34;&#34;&#34;Plate class

    This is not the physical 384-well plate, but the mock 96-well
    plate of a single dilution.


    Parameters
    -----------
    df : pandas.DataFrame

    Attributes
    -----------
    df : pandas.DataFrame
        Dataframe, similar to input `df` but with additional columns from
        `Plate.subtract_plaque_area_background()` and
        `Plate.calc_percentage_infected()`.
    barcode : string
        Mock plate barcode. This is not the scanned barcode,
        but the mock 96-well plate barcode determined from the
        actual 384-well barcode.
    dilution : int
        Dilution integer of the plate, (1, 2, 3, 4).
    plate_failed : bool
        `True` if the entire plate is a QC failure, otherwise `False`.
    well_failures : list
        List containing WellFailure classes if any wells have failed.
    plate_failures : list
        List containing PlateFailure classes if the plate has failed
        for one of more QC reasons.
    &#34;&#34;&#34;

    def __init__(self, df: pd.DataFrame):
        self.df = self.subtract_plaque_area_background(df)
        assert df[&#34;PlateNum&#34;].nunique() == 1
        self.barcode = df[&#34;Plate_barcode&#34;].values[0]
        assert df[&#34;Dilution&#34;].nunique() == 1
        self.dilution = df[&#34;Dilution&#34;].values[0]
        self.plate_failed = False
        self.well_failures: Set[failure.WellFailure] = set()
        self.plate_failures: Set[failure.PlateFailure] = set()
        self.calc_percentage_infected()
        self.outside_image_area()

    def __len__(self):
        return self.df.shape[0]

    def __str__(self):
        return f&#34;Plate {self.barcode}&#34;

    def outside_image_area(self) -&gt; None:
        &#34;&#34;&#34;QC check for `cell_region_area`

        Determines if `cell_region_area` is outside the expected range and
        adds any failures to `well_failures`.
        &#34;&#34;&#34;
        feature = &#34;Cells - Image Region Area [µm²] - Mean per Well&#34;
        experiment_median = self.df[feature].median()
        ratio = self.df[feature] / experiment_median
        self.df[&#34;ratio&#34;] = ratio
        lower_limit = qc_criteria.low_cells_image_region_area_low
        upper_limit = qc_criteria.low_cells_image_region_area_high
        low = self.df[self.df[&#34;ratio&#34;] &lt; lower_limit]
        high = self.df[self.df[&#34;ratio&#34;] &gt; upper_limit]
        outliers = pd.concat([low, high])
        control_outliers = outliers[outliers[&#34;Well&#34;].str.endswith(&#34;12&#34;)]
        if control_outliers.shape[0] &gt; 0:
            # plate failure due to control well failure
            self.plate_failed = True
            failed_plate = failure.PlateFailure(
                plate=self.barcode,
                wells=&#34;;&#34;.join(control_outliers[&#34;Well&#34;].tolist()),
                failure_reason=failure.CELL_IMAGE_AREA_FAILURE_REASON,
            )
            self.plate_failures.add(failed_plate)
        if outliers.shape[0]:
            for _, row in outliers.iterrows():
                well_failure = failure.WellFailure(
                    well=row[&#34;Well&#34;],
                    plate=self.barcode,
                    failure_reason=failure.CELL_REGION_FAILURE_REASON,
                )
                self.well_failures.add(well_failure)
            # if there&#39;s more than 8 failures for DAPI wells, then flag
            # as a possible plate failure
            if outliers.shape[0] &gt; 8:
                # flag possible plate fail
                failed_plate = failure.PlateFailure(
                    plate=self.barcode,
                    wells=&#34;;&#34;.join(outliers[&#34;Well&#34;].tolist()),
                    failure_reason=failure.DAPI_PLATE_FAILURE_REASON,
                )
                self.plate_failures.add(failed_plate)

    def subtract_plaque_area_background(self, df: pd.DataFrame) -&gt; pd.DataFrame:
        &#34;&#34;&#34;Remove background from `plaque_area`.

        1. Calculate the median of &#34;Normalised Plaque area&#34; fo no virus wells.

        2. Subtract median from &#34;Normalised Plaque area&#34; for each well and save
          as &#34;Background Subtracted Plaque Area&#34;

        This is now done on a plate-by-plate basis.

        Parameters
        -----------
        df : pandas.DataFrame

        Returns
        -------
        pandas.DataFrame
        &#34;&#34;&#34;
        feature = &#34;Normalised Plaque area&#34;
        new_colname = &#34;Background Subtracted Plaque Area&#34;
        no_virus_bool = df.Well.isin(NO_VIRUS_WELLS)
        background = df[no_virus_bool][feature].median()
        df[new_colname] = df[feature] - background
        return df

    def check_infection(self, infection: float) -&gt; None:
        &#34;&#34;&#34;
        Determines if infection rate of virus-only-wells is within
        acceptable limts, flag as a plate failure if this is false.

        Parameters
        -----------
        infection: float
            infection rate of virus-only wells

        Returns
        -------
        None
            Adds a `plaque_assay.failure.PlateFailure` to
            `self.plate_failures` if plate has failed.
        &#34;&#34;&#34;
        lower_limit = qc_criteria.infection_rate_low
        upper_limit = qc_criteria.infection_rate_high
        if infection &lt; lower_limit or infection &gt; upper_limit:
            reason = f&#34;virus-only infection median ({infection:3f}) outside range: ({lower_limit}, {upper_limit})&#34;
            self.plate_failed = True
            failed_plate = failure.PlateFailure(
                plate=self.barcode,
                wells=&#34;;&#34;.join(VIRUS_ONLY_WELLS),
                failure_reason=reason,
            )
            self.plate_failures.add(failed_plate)

    def calc_percentage_infected(self) -&gt; None:
        &#34;&#34;&#34;Calculate percentage infected.

        `Percentage Infected` is the `Background Subtracted Plaque Area`
        divided by the median of the virus only wells x 100.

        Notes
        ------
        Also carries out a QC check. Determines if infection rate of
        virus-only-wells is within acceptable limts, flag the plate if
        this is false.
        &#34;&#34;&#34;
        feature = &#34;Background Subtracted Plaque Area&#34;
        virus_only_bool = self.df.Well.isin(VIRUS_ONLY_WELLS)
        infection = self.df[virus_only_bool][feature].median()
        self.check_infection(infection)
        self.df[&#34;Percentage Infected&#34;] = self.df[feature] / infection * 100

    def get_normalised_data(self) -&gt; pd.DataFrame:
        &#34;&#34;&#34;Return a simplified dataframe of just the normalised data

        This subsets and renames some columns.

        Returns
        -------
        pandas.DataFrame
        &#34;&#34;&#34;
        wanted_cols = [
            &#34;Well&#34;,
            &#34;Row&#34;,
            &#34;Column&#34;,
            &#34;Dilution&#34;,
            &#34;Plate_barcode&#34;,
            &#34;Background Subtracted Plaque Area&#34;,
            &#34;Percentage Infected&#34;,
            &#34;variant&#34;,
        ]
        temp_df = self.df.copy()
        df_wanted = temp_df[wanted_cols]
        df_wanted = df_wanted.rename(
            columns={
                &#34;Background Subtracted Plaque Area&#34;: &#34;Background_subtracted_plaque_area&#34;,
                &#34;Percentage Infected&#34;: &#34;Percentage_infected&#34;,
            }
        )
        return df_wanted

    def save_normalised_data(self, output_dir: str) -&gt; None:
        &#34;&#34;&#34;Save csv of the normalised data

        Parameters
        -----------
        output_dir : str
            directory in which to save the csv file
        &#34;&#34;&#34;
        norm_data = self.get_normalised_data()
        save_path = os.path.join(output_dir, f&#34;{self.barcode}.csv&#34;)
        norm_data.to_csv(save_path, index=False)</code></pre>
</details>
<h3>Methods</h3>
<dl>
<dt id="plaque_assay.plate.Plate.calc_percentage_infected"><code class="name flex">
<span>def <span class="ident">calc_percentage_infected</span></span>(<span>self) ‑> NoneType</span>
</code></dt>
<dd>
<div class="desc"><p>Calculate percentage infected.</p>
<p><code>Percentage Infected</code> is the <code>Background Subtracted Plaque Area</code>
divided by the median of the virus only wells x 100.</p>
<h2 id="notes">Notes</h2>
<p>Also carries out a QC check. Determines if infection rate of
virus-only-wells is within acceptable limts, flag the plate if
this is false.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def calc_percentage_infected(self) -&gt; None:
    &#34;&#34;&#34;Calculate percentage infected.

    `Percentage Infected` is the `Background Subtracted Plaque Area`
    divided by the median of the virus only wells x 100.

    Notes
    ------
    Also carries out a QC check. Determines if infection rate of
    virus-only-wells is within acceptable limts, flag the plate if
    this is false.
    &#34;&#34;&#34;
    feature = &#34;Background Subtracted Plaque Area&#34;
    virus_only_bool = self.df.Well.isin(VIRUS_ONLY_WELLS)
    infection = self.df[virus_only_bool][feature].median()
    self.check_infection(infection)
    self.df[&#34;Percentage Infected&#34;] = self.df[feature] / infection * 100</code></pre>
</details>
</dd>
<dt id="plaque_assay.plate.Plate.check_infection"><code class="name flex">
<span>def <span class="ident">check_infection</span></span>(<span>self, infection: float) ‑> NoneType</span>
</code></dt>
<dd>
<div class="desc"><p>Determines if infection rate of virus-only-wells is within
acceptable limts, flag as a plate failure if this is false.</p>
<h2 id="parameters">Parameters</h2>
<dl>
<dt><strong><code>infection</code></strong> :&ensp;<code>float</code></dt>
<dd>infection rate of virus-only wells</dd>
</dl>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>None</code></dt>
<dd>Adds a <code><a title="plaque_assay.failure.PlateFailure" href="failure.html#plaque_assay.failure.PlateFailure">PlateFailure</a></code> to
<code>self.plate_failures</code> if plate has failed.</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def check_infection(self, infection: float) -&gt; None:
    &#34;&#34;&#34;
    Determines if infection rate of virus-only-wells is within
    acceptable limts, flag as a plate failure if this is false.

    Parameters
    -----------
    infection: float
        infection rate of virus-only wells

    Returns
    -------
    None
        Adds a `plaque_assay.failure.PlateFailure` to
        `self.plate_failures` if plate has failed.
    &#34;&#34;&#34;
    lower_limit = qc_criteria.infection_rate_low
    upper_limit = qc_criteria.infection_rate_high
    if infection &lt; lower_limit or infection &gt; upper_limit:
        reason = f&#34;virus-only infection median ({infection:3f}) outside range: ({lower_limit}, {upper_limit})&#34;
        self.plate_failed = True
        failed_plate = failure.PlateFailure(
            plate=self.barcode,
            wells=&#34;;&#34;.join(VIRUS_ONLY_WELLS),
            failure_reason=reason,
        )
        self.plate_failures.add(failed_plate)</code></pre>
</details>
</dd>
<dt id="plaque_assay.plate.Plate.get_normalised_data"><code class="name flex">
<span>def <span class="ident">get_normalised_data</span></span>(<span>self) ‑> pandas.core.frame.DataFrame</span>
</code></dt>
<dd>
<div class="desc"><p>Return a simplified dataframe of just the normalised data</p>
<p>This subsets and renames some columns.</p>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>pandas.DataFrame</code></dt>
<dd>&nbsp;</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def get_normalised_data(self) -&gt; pd.DataFrame:
    &#34;&#34;&#34;Return a simplified dataframe of just the normalised data

    This subsets and renames some columns.

    Returns
    -------
    pandas.DataFrame
    &#34;&#34;&#34;
    wanted_cols = [
        &#34;Well&#34;,
        &#34;Row&#34;,
        &#34;Column&#34;,
        &#34;Dilution&#34;,
        &#34;Plate_barcode&#34;,
        &#34;Background Subtracted Plaque Area&#34;,
        &#34;Percentage Infected&#34;,
        &#34;variant&#34;,
    ]
    temp_df = self.df.copy()
    df_wanted = temp_df[wanted_cols]
    df_wanted = df_wanted.rename(
        columns={
            &#34;Background Subtracted Plaque Area&#34;: &#34;Background_subtracted_plaque_area&#34;,
            &#34;Percentage Infected&#34;: &#34;Percentage_infected&#34;,
        }
    )
    return df_wanted</code></pre>
</details>
</dd>
<dt id="plaque_assay.plate.Plate.outside_image_area"><code class="name flex">
<span>def <span class="ident">outside_image_area</span></span>(<span>self) ‑> NoneType</span>
</code></dt>
<dd>
<div class="desc"><p>QC check for <code>cell_region_area</code></p>
<p>Determines if <code>cell_region_area</code> is outside the expected range and
adds any failures to <code>well_failures</code>.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def outside_image_area(self) -&gt; None:
    &#34;&#34;&#34;QC check for `cell_region_area`

    Determines if `cell_region_area` is outside the expected range and
    adds any failures to `well_failures`.
    &#34;&#34;&#34;
    feature = &#34;Cells - Image Region Area [µm²] - Mean per Well&#34;
    experiment_median = self.df[feature].median()
    ratio = self.df[feature] / experiment_median
    self.df[&#34;ratio&#34;] = ratio
    lower_limit = qc_criteria.low_cells_image_region_area_low
    upper_limit = qc_criteria.low_cells_image_region_area_high
    low = self.df[self.df[&#34;ratio&#34;] &lt; lower_limit]
    high = self.df[self.df[&#34;ratio&#34;] &gt; upper_limit]
    outliers = pd.concat([low, high])
    control_outliers = outliers[outliers[&#34;Well&#34;].str.endswith(&#34;12&#34;)]
    if control_outliers.shape[0] &gt; 0:
        # plate failure due to control well failure
        self.plate_failed = True
        failed_plate = failure.PlateFailure(
            plate=self.barcode,
            wells=&#34;;&#34;.join(control_outliers[&#34;Well&#34;].tolist()),
            failure_reason=failure.CELL_IMAGE_AREA_FAILURE_REASON,
        )
        self.plate_failures.add(failed_plate)
    if outliers.shape[0]:
        for _, row in outliers.iterrows():
            well_failure = failure.WellFailure(
                well=row[&#34;Well&#34;],
                plate=self.barcode,
                failure_reason=failure.CELL_REGION_FAILURE_REASON,
            )
            self.well_failures.add(well_failure)
        # if there&#39;s more than 8 failures for DAPI wells, then flag
        # as a possible plate failure
        if outliers.shape[0] &gt; 8:
            # flag possible plate fail
            failed_plate = failure.PlateFailure(
                plate=self.barcode,
                wells=&#34;;&#34;.join(outliers[&#34;Well&#34;].tolist()),
                failure_reason=failure.DAPI_PLATE_FAILURE_REASON,
            )
            self.plate_failures.add(failed_plate)</code></pre>
</details>
</dd>
<dt id="plaque_assay.plate.Plate.save_normalised_data"><code class="name flex">
<span>def <span class="ident">save_normalised_data</span></span>(<span>self, output_dir: str) ‑> NoneType</span>
</code></dt>
<dd>
<div class="desc"><p>Save csv of the normalised data</p>
<h2 id="parameters">Parameters</h2>
<dl>
<dt><strong><code>output_dir</code></strong> :&ensp;<code>str</code></dt>
<dd>directory in which to save the csv file</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def save_normalised_data(self, output_dir: str) -&gt; None:
    &#34;&#34;&#34;Save csv of the normalised data

    Parameters
    -----------
    output_dir : str
        directory in which to save the csv file
    &#34;&#34;&#34;
    norm_data = self.get_normalised_data()
    save_path = os.path.join(output_dir, f&#34;{self.barcode}.csv&#34;)
    norm_data.to_csv(save_path, index=False)</code></pre>
</details>
</dd>
<dt id="plaque_assay.plate.Plate.subtract_plaque_area_background"><code class="name flex">
<span>def <span class="ident">subtract_plaque_area_background</span></span>(<span>self, df: pandas.core.frame.DataFrame) ‑> pandas.core.frame.DataFrame</span>
</code></dt>
<dd>
<div class="desc"><p>Remove background from <code>plaque_area</code>.</p>
<ol>
<li>
<p>Calculate the median of "Normalised Plaque area" fo no virus wells.</p>
</li>
<li>
<p>Subtract median from "Normalised Plaque area" for each well and save
as "Background Subtracted Plaque Area"</p>
</li>
</ol>
<p>This is now done on a plate-by-plate basis.</p>
<h2 id="parameters">Parameters</h2>
<dl>
<dt><strong><code>df</code></strong> :&ensp;<code>pandas.DataFrame</code></dt>
<dd>&nbsp;</dd>
</dl>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>pandas.DataFrame</code></dt>
<dd>&nbsp;</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def subtract_plaque_area_background(self, df: pd.DataFrame) -&gt; pd.DataFrame:
    &#34;&#34;&#34;Remove background from `plaque_area`.

    1. Calculate the median of &#34;Normalised Plaque area&#34; fo no virus wells.

    2. Subtract median from &#34;Normalised Plaque area&#34; for each well and save
      as &#34;Background Subtracted Plaque Area&#34;

    This is now done on a plate-by-plate basis.

    Parameters
    -----------
    df : pandas.DataFrame

    Returns
    -------
    pandas.DataFrame
    &#34;&#34;&#34;
    feature = &#34;Normalised Plaque area&#34;
    new_colname = &#34;Background Subtracted Plaque Area&#34;
    no_virus_bool = df.Well.isin(NO_VIRUS_WELLS)
    background = df[no_virus_bool][feature].median()
    df[new_colname] = df[feature] - background
    return df</code></pre>
</details>
</dd>
</dl>
</dd>
</dl>
</section>
</article>
<nav id="sidebar">
<h1>Index</h1>
<div class="toc">
<ul></ul>
</div>
<ul id="index">
<li><h3>Super-module</h3>
<ul>
<li><code><a title="plaque_assay" href="index.html">plaque_assay</a></code></li>
</ul>
</li>
<li><h3><a href="#header-classes">Classes</a></h3>
<ul>
<li>
<h4><code><a title="plaque_assay.plate.Plate" href="#plaque_assay.plate.Plate">Plate</a></code></h4>
<ul class="">
<li><code><a title="plaque_assay.plate.Plate.calc_percentage_infected" href="#plaque_assay.plate.Plate.calc_percentage_infected">calc_percentage_infected</a></code></li>
<li><code><a title="plaque_assay.plate.Plate.check_infection" href="#plaque_assay.plate.Plate.check_infection">check_infection</a></code></li>
<li><code><a title="plaque_assay.plate.Plate.get_normalised_data" href="#plaque_assay.plate.Plate.get_normalised_data">get_normalised_data</a></code></li>
<li><code><a title="plaque_assay.plate.Plate.outside_image_area" href="#plaque_assay.plate.Plate.outside_image_area">outside_image_area</a></code></li>
<li><code><a title="plaque_assay.plate.Plate.save_normalised_data" href="#plaque_assay.plate.Plate.save_normalised_data">save_normalised_data</a></code></li>
<li><code><a title="plaque_assay.plate.Plate.subtract_plaque_area_background" href="#plaque_assay.plate.Plate.subtract_plaque_area_background">subtract_plaque_area_background</a></code></li>
</ul>
</li>
</ul>
</li>
</ul>
</nav>
</main>
<footer id="footer">
<p>Generated by <a href="https://pdoc3.github.io/pdoc"><cite>pdoc</cite> 0.9.2</a>.</p>
</footer>
</body>
</html>